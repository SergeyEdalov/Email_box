# Почтовый ящик
Простое приложение почтового ящика для отправки/приемки сообщений. Выполнен на 2-х микросервисах: User, Message.

## Содержание
- [Стек проекта](#Стек-проекта)
- [Функциональность проекта](#Функциональность-проекта)
- [Описание микросервисов](#Описание-микросервисов)
  - [User](#User)
  - [Message](#Message)
- [База данных](#База-данных)
- [Docker](#Docker)
- [RabbitMQ](#RabbitMQ)
- [API Gateway(Ocelot)](#API-Gateway(Ocelot))
- [UnitTests](#UnitTests)
- [Запуск проекта](#Запуск-проекта)
- [P.S.](#P.S.)
---
### <a id="Стек-проекта">Стек проекта</a>
* [Asp Net Core](https://learn.microsoft.com/ru-ru/aspnet/core/introduction-to-aspnet-core?view=aspnetcore-8.0)
* [Entity Framework Core](https://docs.microsoft.com/ru-ru/ef/core/)
* Unit Tests
* [Docker](https://www.docker.com/)
* [RabbitMQ](https://www.rabbitmq.com/)
* [Api Gateway (Ocelot)](https://ocelot.readthedocs.io/en/latest/features/configuration.html)
---
### <a id="Функциональность-проекта">Функциональность проекта</a>
1. Сервис User
    - Аутентификация и авторизация
    - Добавление пользователя
    - Получение списка пользователей
    - Удаление пользователя
    - Получение id пользователя
2. Сервис Message
    - Отправка сообщений
    - Получение сообщений

---
### <a id="Описание-микросервисов">Описание микросервисов</a>
Оба микросервиса используют swagger(OpenApi). В них также присутствует Autofac для инверсии зависимостей. Прежде чем попасть в базу, данные проходят через Automapper. Сервис [User](#User) отправляет данные сервису [Message](#Message) через [RabbitMQ](#RabbitMQ).   
В каждом микросервисе присутсвует контроллер, сервис управления, конекст для работы с БД.

#### <a id="User">User</a>
> https://localhost:7205/swagger/index.html

Микросервис осуществляет контроль пользователей в системе. Сущность содержит идентификатор (Guid), логин (за основу взят e-mail пользователя), пароль (конкатенируется с солью и вычисляется хэш), роль в системе (администратор или пользователь).
 * Аутентификация и авторизация  
Микросервис выполняет функции аутентификации и управления пользователями. 
Аутентификация происходит с помощью RSA-шифрования. В ответ направляется JWT-токен, в котором содержится id пользователя и его роль. В дальнейшем токен направляется в микросервис Message для проверки авторизации. Конкретнее, его нужно положить в заголовок Authorization.
 * Добавить администратора  
Метод проверяет есть ли пользователи в системе, если нет, добавляет администратора.
Е-mail проверяется по шаблону. Пароль проходит проверку по длине и сложности. Для этого создана библиотека для проверки входящих данных.
 * Добавить пользователя  
 Метод проверяет есть ли пользователь с таким именем в системе. Если нет, добавляет пользователя.
 * Получить список пользователей  
 Метод выводит список всех пользователей в системе.
 * Удалить пользователя  
 Метод удаляет пользователей, кроме администратора.
 * Получить id пользователя  
 Метод возвращает id пользователя из JWT-токена. Токен проходит проверку на валидность.

#### <a id="Message">Message</a>
> https://localhost:7191/swagger/index.html  

Микросервис выполняет функцию мессенджера. Полученные токен от сервиса User проверяется на валидность. Затем дается доступ к отправке и получению сообщений. Сущность содержит идентификатор (Guid), тело сообщения, от кого направлено, кому направлено.
 * Получить сообщения  
 Метод возвращает все неполученные сообщения от других пользователей. При этом сообщения помечаются, как прочитанные.
 * Отправить сообщение  
 Метод отправляет сообщение другому пользователю.  

---

### <a id="База-данных">База данных</a>
> http://localhost:8080  

В проекте используются 2 базы данных. 

 * Для микросервиса User
 * Для микросервиса Message

Для входа в adminer введите следующие данные:

* Движок - PostgreSQL
* Сервер - db
* Имя пользователя - postgres
* Пароль - example
* База данных - totalAttectation

Подход проектирования БД: Code first  
Тип хранения данных: PostgreSQL & Docker  
ORM: Entity Framework Core  

---
### <a id="Docker">Docker</a>
Для запуска подготовлен docker-compose файл в корне решения. dockerfile располагаются в проектах.

---
### <a id="RabbitMQ">RabbitMQ</a>
> http://localhost:15672   

В проекте реализован брокер сообщений RabbitMq. В качестве издателя выступает сервис User - он отсылает токен пользователя в очередь сообщений, в качестве подписчика сервис Mеssage - находится в состоянии прослушивания очереди сообщений. При получении из очереди данных проводится проверка авторизации.

Для входа введите следующие данные:

* Имя - guest
* Пароль - guest

---
### <a id="API-Gateway(Ocelot)">API Gateway(Ocelot)</a>
> https://localhost:7052/swagger/index.html

В проекте реализован Ocelot API Gateway для переадресации методов. Для конфигурирования проекта подключается totalAttectation.json файл, в котором расписаны пути, а также методы переадресации.

---
### <a id="UnitTests">UnitTests</a>
Проект SolutionTests содержит Unit-тесты на функционал микросервисов User и Message.

---
### <a id="Запуск-проекта">Запуск проекта</a>
#### 1-й вариант   
Можно запуститься через программу docker. Для запуска в терминале необходимо прописать следующие команды:  
 * git clone <адрес репозитория на Github>
 * docker-compose up    

После этого перейдите по указанным адресам.
#### 2-й вариант 
Можно запуститься через среду разработки. В docker запустить контейнеры с базой данных, adminer и RabbitMq. Затем в Visual Studio (или другой IDE) запустить проекты User, Message, APIGateway. Перед запуском в проектах User(RabbitMqService), Message(Program.cs) следует поменять имя хоста службы RabbitMq на "localhost".

Для запуска необходимо прописать следующие команды:  
 * git clone <адрес репозитория на Github>
 * docker-compose up <Имя контейнера>

---
### <a id="P.S.">P.S.</a>
Это мой первый проект, так что прошу привнести максимально объективную критику.